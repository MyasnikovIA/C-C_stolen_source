$(function(){function m(a){var b=this;this.loaded=!1;var c=new Image;return c.src="images/"+a,this.preloadCount++,$(c).bind("load",function(){b.loadedCount++,b.loadedCount==b.preloadCount&&(b.loaded=!0)}),c}function n(a,b,c){c||(c=".png");var d=[];for(var e=0;e<b;e++)d.push(this.preloadImage(a+"-"+e+c));return d}function o(){var a=this.health/this.hitPoints;a>.7?this.life="healthy":a>.4?this.life="damaged":this.life="ultra-damaged"}function p(){if(this.selected){b.strokeStyle="white";var a=5,c=this.x*d.gridSize+d.viewportAdjustX+this.pixelOffsetX,f=this.y*d.gridSize+d.viewportAdjustY+this.pixelOffsetY,g=c+this.pixelLeft,h=f+this.pixelTop,i=g+this.pixelWidth,j=h+this.pixelHeight;b.beginPath(),b.moveTo(g,h+a),b.lineTo(g,h),b.lineTo(g+a,h),b.moveTo(i-a,h),b.lineTo(i,h),b.lineTo(i,h+a),b.moveTo(i,j-a),b.lineTo(i,j),b.lineTo(i-a,j),b.moveTo(g+a,j),b.lineTo(g,j),b.lineTo(g,j-a),b.stroke(),this.getLife(),b.beginPath(),b.rect(g,h-a-2,this.pixelWidth*this.health/this.hitPoints,a),this.life=="healthy"?b.fillStyle="lightgreen":this.life=="damaged"?b.fillStyle="yellow":b.fillStyle="red",b.fill(),b.beginPath(),b.strokeStyle="black",b.rect(g,h-a-2,this.pixelWidth,a),b.stroke(),this.primaryBuilding&&b.drawImage(e.primaryBuildingImage,(g+i-e.primaryBuildingImage.width)/2,j-e.primaryBuildingImage.height)}}function q(a,b){var c=this.x*d.gridSize+this.pixelOffsetX,e=this.y*d.gridSize+this.pixelOffsetY,f=c+this.pixelLeft,g=e+this.pixelTop,h=f+this.pixelWidth,i=g+this.pixelHeight;return a<f||a>h||b<g||b>i?!1:!0}function r(a){var b=[];a||(a=this);for(var c=d.units.length-1;c>=0;c--){var e=d.units[c];e.team!=a.team&&Math.pow(e.x-a.x,2)+Math.pow(e.y-a.y,2)<=Math.pow(a.sight,2)&&b.push(e)}for(var c=d.buildings.length-1;c>=0;c--){var e=d.buildings[c];e.team!=a.team&&Math.pow(e.x+e.gridWidth/2-a.x,2)+Math.pow(e.y+e.gridHeight/2-a.y,2)<=Math.pow(a.sight,2)&&b.push(e)}for(var c=d.turrets.length-1;c>=0;c--){var e=d.turrets[c];e.team!=a.team&&Math.pow(e.x+e.gridWidth/2-a.x,2)+Math.pow(e.y+e.gridHeight/2-a.y,2)<=Math.pow(a.sight,2)&&b.push(e)}return b}function s(a,c){var e=d.obstructionGrid;e[a[1]][a[0]]=0;var f=A(e,a,c,"Euclidean");if(f.length>1&&d.debugMode)for(k=0;k<f.length;k++)b.beginPath(),b.fillStyle="rgba(150,50,100,0.5)",b.arc((f[k].x+.5)*d.gridSize+d.viewportAdjustX,(f[k].y+.5)*d.gridSize+d.viewportAdjustY,5,0,2*Math.PI),b.fill();return f}function v(a,c,d,e,f){var g=a.width,h=a.height;u.clearRect(0,0,g+1,h+1),u.drawImage(a,0,0);var i=u.getImageData(0,0,g,h),j=i.data.length/4;for(var k=0;k<j;k++){var l=i.data[k*4],m=i.data[k*4+1],n=i.data[k*4+2],o=i.data[k*4+2];if(e=="nod"){var p=[];if(f=="turret"||f=="building"||f=="mcv"||f=="harvester")p=[{gdi:[198,170,93],nod:[218,0,0]},{gdi:[178,149,80],nod:[191,26,7]},{gdi:[97,76,36],nod:[108,0,0]},{gdi:[145,137,76],nod:[169,27,26]},{gdi:[125,117,64],nod:[133,39,30]},{gdi:[109,101,56],nod:[125,1,0]},{gdi:[89,85,44],nod:[96,41,24]},{gdi:[170,153,85],nod:[190,26,7]},{gdi:[194,174,97],nod:[220,0,0]},{gdi:[246,214,121],nod:[255,0,1]},{gdi:[222,190,105],nod:[246,1,0]}];else if(f=="vehicle"||f=="infantry")i.data[k*4+0]=(l+m+n)/3,i.data[k*4+1]=(l+m+n)/3,i.data[k*4+2]=(l+m+n)/3;for(var q=p.length-1;q>=0;q--)l==p[q].gdi[0]&&m==p[q].gdi[1]&&n==p[q].gdi[2]&&(i.data[k*4+0]=p[q].nod[0],i.data[k*4+1]=p[q].nod[1],i.data[k*4+2]=p[q].nod[2])}m==255&&n<100&&(i.data[k*4]=0,i.data[k*4+1]=0,i.data[k*4+2]=0)}u.globalCompositeOperation="source-over",u.putImageData(i,0,0),u.globalCompositeOperation="destination-atop",u.drawImage(a,0,0),b.drawImage(t,0,0,g,h,c,d,g,h)}function w(a,b,c){return a=Math.floor(a),b=Math.floor(b),a>=c/2&&(a-=c),b>=c/2&&(b-=c),diff=b-a,diff<-c/2&&(diff+=c),diff>c/2&&(diff-=c),diff}function x(a,b,c){return a=Math.round(a)+b,a>c-1&&(a-=c),a<0&&(a+=c),a}function y(a,b,c){c||(c=32),b||(b=this);var d=a.y-b.y,e=a.x-b.x;b.type=="turret"&&(d-=.5,e-=.5);var f=c/2+Math.round(Math.atan2(e,d)*c/(2*Math.PI));return f<0&&(f+=c),f>=c&&(f-=c),f}function z(a,b){var c=!0,d=a[0];while(c&&a.length>2){var e=a[2];if(Math.abs(e.y-d.y)>Math.abs(e.x-d.x)){var f=(e.x-d.x)/(e.y-d.y),g=.2*(e.y-d.y)/Math.abs(e.y-d.y),h=g,i={x:d.x+h*f,y:d.y+h};while(c&&Math.abs(i.y-e.y)>.3)b[Math.floor(i.y)][Math.floor(i.x)]>0&&(c=!1),h+=g,i={x:d.x+h*f,y:d.y+h}}else{var f=(e.y-d.y)/(e.x-d.x),j=.2*(e.x-d.x)/Math.abs(e.x-d.x),k=j,i={x:d.x+k,y:d.y+f*k};while(c&&Math.abs(i.x-e.x)>=.3)b[Math.floor(i.y)][Math.floor(i.x)]>0&&(c=!1),k+=j,i={x:d.x+k,y:d.y+f*k}}c&&a.splice(1,1)}}var a=$("#canvas")[0],b=a.getContext("2d"),c={x:0,y:0,gridX:0,gridY:0,gameX:0,gameY:0,insideCanvas:!1,panDirection:"",panningThreshold:48,panningVelocity:24,handlePanning:function(){var a="";c.insideCanvas&&(c.y>d.viewportTop+c.panningThreshold||c.y<d.viewportTop?c.y<d.viewportTop+d.viewportHeight-c.panningThreshold||c.y>d.viewportTop+d.viewportHeight?(d.viewportDeltaY=0,a+=""):(d.viewportDeltaY=c.panningVelocity,a+="_bottom"):(d.viewportDeltaY=-c.panningVelocity,a+="_top"),c.x>=c.panningThreshold||c.y<d.viewportTop||c.y>d.viewportTop+d.viewportHeight?c.x<=d.screenWidth-c.panningThreshold||c.y<d.viewportTop||c.y>d.viewportTop+d.viewportHeight?(d.viewportDeltaX=0,a+=""):(d.viewportDeltaX=c.panningVelocity,a+="_right"):(d.viewportDeltaX=-c.panningVelocity,a+="_left"));if(d.viewportX+d.viewportDeltaX<0||d.viewportX+d.viewportDeltaX+d.screenWidth>d.currentLevel.mapImage.width)d.viewportDeltaX=0;if(d.viewportY+d.viewportDeltaY<0||d.viewportY+d.viewportDeltaY+d.viewportHeight>d.currentLevel.mapImage.height)d.viewportDeltaY=0;a!=""&&(d.viewportDeltaX==0&&d.viewportDeltaY==0?a="no_pan"+a:a="pan"+a),c.panDirection=a,d.viewportX+=d.viewportDeltaX,d.viewportY+=d.viewportDeltaY,c.gameX=c.x+d.viewportX-d.viewportLeft,c.gameY=c.y+d.viewportY-d.viewportTop,d.viewportAdjustX=d.viewportLeft-d.viewportX,d.viewportAdjustY=d.viewportTop-d.viewportY},cursorLoop:0,drawCursor:function(){if(!this.insideCanvas)return;this.cursorLoop++,this.cursorLoop>=this.cursor.cursorSpeed*this.cursor.images.length&&(this.cursorLoop=0);if(this.dragSelect){var a=Math.min(this.gameX,this.dragX),c=Math.min(this.gameY,this.dragY),e=Math.abs(this.gameX-this.dragX),f=Math.abs(this.gameY-this.dragY);b.strokeStyle="white",b.strokeRect(a+d.viewportAdjustX,c+d.viewportAdjustY,e,f)}var g=this.cursor.images[Math.floor(this.cursorLoop/this.cursor.cursorSpeed)];b.drawImage(g,this.x-this.cursor.x,this.y-this.cursor.y)},checkOverObject:function(){this.overObject=null;for(var a=d.units.length-1;a>=0;a--)if(d.units[a].underPoint&&d.units[a].underPoint(this.gameX,this.gameY)){this.overObject=d.units[a];break}for(var a=d.buildings.length-1;a>=0;a--)if(d.buildings[a].underPoint(this.gameX,this.gameY)){this.overObject=d.buildings[a];break}for(var a=d.turrets.length-1;a>=0;a--)if(d.turrets[a].underPoint(this.gameX,this.gameY)){this.overObject=d.turrets[a];break}return this.overObject},draw:function(){this.cursor=this.cursors["default"];var a=this.checkOverObject();if(this.y>=d.viewportTop&&this.y<=d.viewportTop+d.viewportHeight)if(e.deployMode){var b=f.types[e.deployBuilding],g=$.extend([],b.gridShape);g.push(g[g.length-1]);for(var h=0;h<g.length;h++)for(var i=0;i<g[h].length;i++)g[h][i]==1&&(d.obstructionGrid[c.gridY+h][c.gridX+i]==1?d.highlightGrid(c.gridX+i,c.gridY+h,1,1,e.placementRedImage):d.highlightGrid(c.gridX+i,c.gridY+h,1,1,e.placementWhiteImage))}else if(e.repairMode)a&&a.team==d.currentLevel.team&&(a.type=="building"||a.type=="turret")&&a.life<a.hitPoints?this.cursor=this.cursors.repair:this.cursor=this.cursors.no_repair;else if(e.sellMode)!a||a.team!=d.currentLevel.team||a.type!="building"&&a.type!="turret"?this.cursor=this.cursors.no_sell:this.cursor=this.cursors.sell;else if(!e.visible||c.x<=e.left)this.dragSelect?this.cursor=this.cursors["default"]:a?a.team!=d.currentLevel.team&&d.selectedAttackers.length>0?this.cursor=this.cursors.attack:this.cursor=this.cursors.select:this.panDirection&&this.panDirection!=""?this.cursor=this.cursors[this.panDirection]:d.selectedAttackers.length>0&&(d.obstructionGrid[c.gridY]&&d.obstructionGrid[c.gridY][c.gridX]==1?this.cursor=this.cursors.no_move:this.cursor=this.cursors.move);this.insideCanvas&&this.drawCursor()},click:function(a,b){c.y<=d.viewportTop&&c.y>d.viewportTop-15?(c.x<0||c.x>=160)&&(c.x<320||c.x>=480)&&c.x>=480&&c.x<640&&(e.visible=!e.visible):c.y>=d.viewportTop&&c.y<=d.viewportTop+d.viewportHeight&&(e.visible&&c.x>e.left?e.click(a,b):d.click(a,b))},listenEvents:function(){$("#canvas").mousemove(function(a){var b=$("#canvas").offset();c.x=a.pageX-b.left,c.y=a.pageY-b.top,c.gridX=Math.floor(c.gameX/d.gridSize),c.gridY=Math.floor(c.gameY/d.gridSize);if(c.buttonPressed){if(Math.abs(c.dragX-c.gameX)>5||Math.abs(c.dragY-c.gameY)>5)c.dragSelect=!0}else c.dragSelect=!1}),$("#canvas").click(function(a){return c.click(a,!1),c.dragSelect=!1,!1}),$("#canvas").mousedown(function(a){return a.which==1&&(c.buttonPressed=!0,c.dragX=c.gameX,c.dragY=c.gameY,a.preventDefault()),!1}),$("#canvas").bind("contextmenu",function(a){return c.click(a,!0),!1}),$("#canvas").mouseup(function(a){if(a.which==1){if(c.dragSelect){a.shiftKey||d.clearSelection();var b=Math.min(c.gameX,c.dragX),e=Math.min(c.gameY,c.dragY),f=Math.max(c.gameX,c.dragX),g=Math.max(c.gameY,c.dragY);for(var h=d.units.length-1;h>=0;h--){var i=d.units[h];!i.selected&&i.team==d.currentLevel.team&&b<=i.x*d.gridSize&&f>=i.x*d.gridSize&&e<=i.y*d.gridSize&&g>=i.y*d.gridSize&&d.selectItem(i)}}c.buttonPressed=!1}return!1}),$("#canvas").mouseleave(function(a){c.insideCanvas=!1}),$("#canvas").mouseenter(function(a){c.buttonPressed=!1,c.insideCanvas=!0})},loaded:!1,preloadCount:0,loadedCount:0,preloadImage:m,loadImageArray:n,cursors:{},loadCursor:function(a,b,c,d,e){!b&&!c&&(b=0,c=0),e||(e=1);var f;d?f=this.loadImageArray("cursors/"+a,d,".gif"):f=[this.preloadImage("cursors/"+a+".gif")],this.cursors[a]={x:b,y:c,name:a,images:f,cursorSpeed:e}},loadAllCursors:function(){c.loadCursor("default"),c.loadCursor("no_default"),c.loadCursor("move",15,12),c.loadCursor("no_move",15,12),c.loadCursor("pan_top",15,0),c.loadCursor("pan_top_right",30,0),c.loadCursor("pan_right",30,12),c.loadCursor("pan_bottom_right",30,24),c.loadCursor("pan_bottom",15,24),c.loadCursor("pan_bottom_left",0,24),c.loadCursor("pan_left",0,12),c.loadCursor("pan_top_left",0,0),c.loadCursor("no_pan_top",15,0),c.loadCursor("no_pan_top_right",30,0),c.loadCursor("no_pan_right",30,12),c.loadCursor("no_pan_bottom_right",30,24),c.loadCursor("no_pan_bottom",15,24),c.loadCursor("no_pan_bottom_left",0,24),c.loadCursor("no_pan_left",0,12),c.loadCursor("no_pan_top_left",0,0),c.loadCursor("no_repair",15,0),c.loadCursor("no_sell",15,12),c.loadCursor("build_command",15,12,8),c.loadCursor("sell",15,12,24),c.loadCursor("repair",15,0,24),c.loadCursor("attack",15,12,8),c.loadCursor("big_detonate",15,12,3),c.loadCursor("detonate",15,12,3),c.loadCursor("load_vehicle",15,12,3),c.loadCursor("select",15,12,6,2)}},d={screenWidth:a.width,screenHeight:a.height,viewportTop:35,viewportLeft:0,viewportX:0,viewportY:0,viewportDeltaX:0,viewportDeltaY:0,gridSize:24,animationLoop:null,animationTimeout:40,debugMode:!1,speedAdjustmentFactor:.2,setViewport:function(){b.beginPath(),this.viewportWidth=e.visible?this.screenWidth-e.width:this.screenWidth,this.viewportHeight=480,b.rect(this.viewportLeft,this.viewportTop,this.viewportWidth-this.viewportLeft,this.viewportHeight),b.clip()},drawMap:function(){c.handlePanning(),b.drawImage(this.currentLevel.mapImage,this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight,this.viewportLeft,this.viewportTop,this.viewportWidth,this.viewportHeight),d.obstructionGrid=[];for(var a=0;a<this.currentLevel.obstructionGrid.length;a++){d.obstructionGrid[a]=[];for(var e=0;e<this.currentLevel.obstructionGrid[a].length;e++)d.obstructionGrid[a][e]=this.currentLevel.obstructionGrid[a][e]}for(var f=this.buildings.length-1;f>=0;f--){var g=this.buildings[f];for(var a=0;a<g.gridShape.length;a++)for(var e=0;e<g.gridShape[a].length;e++)g.gridShape[a][e]==1&&(d.obstructionGrid[a+g.y][e+g.x]=1)}for(var f=this.turrets.length-1;f>=0;f--)d.obstructionGrid[this.turrets[f].y][this.turrets[f].x]=1;for(var f=this.overlay.length-1;f>=0;f--){var h=this.overlay[f];h.name=="tree"?d.obstructionGrid[h.y][h.x]=1:h.name=="trees"&&(d.obstructionGrid[h.y][h.x]=1,d.obstructionGrid[h.y][h.x+1]=1)}},highlightGrid:function(a,c,e,f,g){var h=d.gridSize;g&&$(g).is("img")?b.drawImage(g,a*h+d.viewportAdjustX,c*h+d.viewportAdjustY,e*h,f*h):(g?b.fillStyle=g:b.fillStyle="rgba(225,225,225,0.5)",b.fillRect(a*h+d.viewportAdjustX,c*h+d.viewportAdjustY,e*h,f*h))},drawGrid:function(){var a=d.gridSize,c=d.currentLevel.mapImage.width,e=d.currentLevel.mapImage.height,f=d.viewportX,g=d.viewportY,h=c/a,i=e/a;b.beginPath(),b.strokeStyle="rgba(30,0,0,.6)";for(var j=0;j<h;j++)b.moveTo(j*a-f+d.viewportLeft,0-g+d.viewportTop),b.lineTo(j*a-f+d.viewportLeft,e-g+d.viewportTop);for(var j=0;j<i;j++)b.moveTo(0-f+d.viewportLeft,j*a-g+d.viewportTop),b.lineTo(c-f+d.viewportLeft,j*a-g+d.viewportTop);b.stroke();for(var j=d.obstructionGrid.length-1;j>=0;j--)for(var k=d.obstructionGrid[j].length-1;k>=0;k--)d.obstructionGrid[j][k]==1&&d.highlightGrid(k,j,1,1,"rgba(100,0,0,0.5)")},units:[],buildings:[],turrets:[],overlay:[],bullets:[],fireBullet:function(a){a.x=a.x-.5*Math.sin(a.angle),a.y=a.y-.5*Math.cos(a.angle),a.range=a.range-.5,this.bullets.push(a),setTimeout(function(){a.source.bulletFiring=!1},a.source.reloadTime)},drawBullets:function(){for(var a=this.bullets.length-1;a>=0;a--){var c=this.bullets[a];c.speed=5,c.range=c.range-.1*c.speed,c.x=c.x-.1*c.speed*Math.sin(c.angle),c.y=c.y-.1*c.speed*Math.cos(c.angle);var e=c.x*d.gridSize,f=c.y*d.gridSize;if(!c.dead){var g;for(var h=d.units.length-1;h>=0;h--)if(d.units[h].underPoint&&d.units[h].underPoint(e,f)&&d.units[h].team!=c.source.team){g=d.units[h];break}for(var h=d.buildings.length-1;h>=0;h--)if(d.buildings[h].underPoint(e,f)){g=d.buildings[h];break}for(var h=d.turrets.length-1;h>=0;h--)if(d.turrets[h].underPoint(e,f)){g=d.turrets[h];break}g&&(c.dead=!0,g.health=g.health-Math.floor((c.damage?c.damage:10)+10*Math.random()),g.health<0&&(g.status="destroy")),b.fillStyle="red",b.fillRect(e+d.viewportAdjustX,f+d.viewportAdjustY,2,2)}c.range<=0&&this.bullets.splice(a,1)}},drawObjects:function(){var a=[];for(var b=this.buildings.length-1;b>=0;b--)this.buildings[b].status=="destroy"&&this.buildings.splice(b,1);for(var b=this.units.length-1;b>=0;b--)this.units[b].status=="destroy"&&this.units.splice(b,1);for(var b=this.turrets.length-1;b>=0;b--)this.turrets[b].status=="destroy"&&this.turrets.splice(b,1);$.merge(a,this.units),$.merge(a,this.buildings),$.merge(a,this.overlay),$.merge(a,this.turrets),a.sort(function(a,b){return b.y-a.y});for(var b=a.length-1;b>=0;b--)a[b].draw()},moveObjects:function(){for(var a=this.units.length-1;a>=0;a--)this.units[a].processOrders&&this.units[a].processOrders(),this.units[a].move();for(var a=this.turrets.length-1;a>=0;a--)this.turrets[a].processOrders&&this.turrets[a].processOrders(),this.turrets[a].move()},showDebugger:function(){var a=function(a){var b="<ul>";for(key in a)if(a.hasOwnProperty(key)){var c=a[key];if(typeof c!="function"||c===null)typeof c=="object"?(b+="<li>"+key+" : ",c instanceof HTMLImageElement?b+=c.src.replace(/^.+images\//,""):c instanceof Array?b+="Array["+c.length+"]":b+="Object"):b+="<li>"+key+" : "+c+"</li>"}return b+="</ul>",b},b="";b+="Level",b+=a(j),b+="Mouse",b+=a(c),d.selectedItems.length==1&&(b+="Selected Item",b+=a(d.selectedItems[0])),b+="Game",b+=a(d),b+="Sidebar",b+=a(e),b+="Vehicles",b+=a(g),b+="Buildings",b+=a(f),$("#debugger").html(b)},animate:function(){if(!j.loaded||!e.loaded||!g.loaded){b.clearRect(0,0,a.width,a.height);return}b.save(),e.draw(),d.setViewport(),d.drawMap(),d.debugMode&&d.drawGrid(),d.moveObjects(),d.drawObjects(),b.restore(),c.draw()},messageVisible:!1,messageHeadingVisible:!1,messageText:"\nCreate a base by deploying your MCV. Build a power plant and weapons factory.\n\nUse your tanks to get rid of all enemy presence in the area.",drawMessage:function(){if(!this.messageVisible)return;b.drawImage(e.messageBox,d.viewportLeft+22,d.viewportTop+150),this.messageHeadingVisible||(b.fillStyle="black",b.fillRect(265,198,120,20)),b.fillStyle="green",b.font='16px "Command and Conquer"';var a=this.messageText.split("\n");for(var c=0;c<a.length;c++)b.fillText(a[c],d.viewportLeft+80,d.viewportTop+200+c*18)},displayMessage:function(a,b){this.messageText=a,this.messageVisible=!0,this.messageHeadingVisible=!!b},selectedItems:[],selectedAttackers:[],clearSelection:function(){for(var a=this.selectedItems.length-1;a>=0;a--)this.selectedItems[a].selected=0,this.selectedItems.splice(a,1);this.selectedAttackers=[]},selectItem:function(a){a.selected=!0,this.selectedItems.push(a),a.type!="building"&&a.team==d.currentLevel.team&&(this.selectedAttackers.push(a),l.play(a.type+"_select"))},click:function(a,b){if(!(!d.messageVisible||c.x<290||c.x>350||c.y<310||c.y>325)){d.messageVisible=!1;return}var f=c.checkOverObject();if(b){this.clearSelection(),e.repairMode=!1,e.deployMode=!1,e.sellMode=!1;return}if(e.repairMode)!f||f.team!=d.currentLevel.team||f.type!="building"&&f.type!="turret"||f.life>=f.hitPoints;else if(e.deployMode)e.finishDeployingBuilding();else if(e.sellMode)f&&f.team==d.currentLevel.team&&(f.type=="building"||f.type=="turret")&&(f.status="sell",l.play("sell"),e.cash+=f.cost/2);else if(!b&&!c.dragSelect)if(f)if(f.team==d.currentLevel.team)a.shiftKey||this.clearSelection(),this.selectItem(f);else if(d.selectedAttackers.length>0)for(var g=d.selectedAttackers.length-1;g>=0;g--)d.selectedAttackers[g].primaryWeapon&&(d.selectedAttackers[g].orders={type:"attack",target:f},l.play(d.selectedAttackers[g].type+"_move"));else a.shiftKey||this.clearSelection(),this.selectItem(f);else if(d.selectedAttackers.length>0)if(!d.obstructionGrid[c.gridY]||d.obstructionGrid[c.gridY][c.gridX]!=1)for(var g=d.selectedAttackers.length-1;g>=0;g--)d.selectedAttackers[g].orders={type:"move",to:{x:c.gridX,y:c.gridY}},l.play(d.selectedAttackers[g].type+"_move")},start:function(){c.loadAllCursors(),l.loadAll(),h.loadAll(),this.currentLevel=j.load("gdi1"),this.overlay=this.currentLevel.overlay,e.load(),c.listenEvents(),d.viewportX=0,d.viewportY=0,e.visible=!1,this.units.push(g.add({name:"mcv",x:23.5,y:23,moveDirection:0})),this.units.push(g.add({name:"mcv",x:25,y:23,moveDirection:0})),this.units.push(g.add({name:"mcv",x:26.5,y:23,moveDirection:0})),this.units.push(g.add({name:"mcv",x:28,y:23,moveDirection:0})),this.units.push(g.add({name:"light-tank",x:19,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:20,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:21,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:23,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:24,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:25,y:4,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:19,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:20,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:21,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:23,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:24,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:25,y:5,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:19,y:6,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:20,y:6,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:21,y:6,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:23,y:6,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:24,y:6,moveDirection:16,turretDirection:16})),this.units.push(g.add({name:"light-tank",x:25,y:6,moveDirection:16,turretDirection:16})),this.animationLoop=setInterval(this.animate,this.animationTimeout)},end:function(){clearInterval(this.statusLoop),e.visible=!1,d.displayMessage("Thank you for trying this demo.This is still a work in progress. \nAny comments, feedback (including bugs), and advice is appreciated.\n\nIf you liked this demo, please share this page with all your friends. ")}},e={loaded:!0,preloadCount:0,loadedCount:0,preloadImage:m,tabsImage:null,width:160,visible:!0,cash:0,finishDeployingBuilding:function(){for(var a=0;a<d.buildings.length;a++)if(d.buildings[a].name=="construction-yard"){d.buildings[a].status="construct";break}d.buildings.push(f.add({name:e.deployBuilding,x:c.gridX,y:c.gridY,status:"build"})),l.play("construction"),e.deployMode=!1;for(var a=this.leftButtons.length-1;a>=0;a--)this.leftButtons[a].status="";e.deployBuilding=null},finishDeployingUnit:function(a){var b;for(var c=0;c<d.buildings.length;c++)if(d.buildings[c].name==a.dependency[0]){b=d.buildings[c];break}a.type=="infantry"?d.units.push(infantry.add({name:a.name,x:b.x+b.gridWidth/2,y:b.y+b.gridHeight,moveDirection:4,instructions:[{type:"move",distance:2}]})):a.type=="vehicle"&&(b.status="construct",d.units.push(g.add({name:a.name,x:b.x+1,y:b.y+2,moveDirection:16,turretDirection:16,instructions:[{type:"move",distance:2},{type:"turn",toDirection:9+Math.round(16*Math.random())}]})));for(var c=this.rightButtons.length-1;c>=0;c--)this.rightButtons[c].dependency[0]==a.dependency[0]&&(this.rightButtons[c].status="");e.deployBuilding=null},click:function(a,b){var d=c.y-this.top,f=c.x;if(d<146||d>160)if(d<455||d>480){if(d>=165&&d<=455){var g=0;for(var h=0;h<6;h++)if(d>=165+h*48&&d<=165+h*48+48){g=h;break}var i,j,k;f<500||f>564?f>=570&&f<=634&&(i="right",j=this.rightButtonOffset+g,k=this.rightButtons):(i="left",j=this.leftButtonOffset+g,k=this.leftButtons);if(k&&k.length>j){var m=k[j];if(m.status==""&&!b)if(m.cost>e.cash)l.play("insufficient_funds");else{for(var h=k.length-1;h>=0;h--)k[h].dependency[0]==m.dependency[0]&&(k[h].status="disabled");m.status="building",m.counter=0,m.spent=m.cost,l.play("building")}else if(m.status=="building"&&!b)l.play("not_ready");else if(m.status=="building"&&b)m.status="hold",l.play("on_hold");else if(m.status=="hold"&&!b)m.status="building",l.play("building");else if(m.status=="hold"&&b){m.status="",l.play("cancelled");for(var h=k.length-1;h>=0;h--)k[h].status=""}else m.status=="ready"&&!b?m.type=="building"&&(e.deployMode=!0,this.repairMode=this.sellMode=this.mapMode=!1,e.deployBuilding=m.name):m.status=="disabled"&&l.play("building_in_progress")}}}else f<500||f>530?f<532||f>562?f<570||f>600?f>=602&&f<=632&&this.rightButtonOffset+6<this.rightButtons.length&&(this.rightButtonOffset++,l.play("button")):this.rightButtonOffset>0&&(this.rightButtonOffset--,l.play("button")):this.leftButtonOffset+6<this.leftButtons.length&&(this.leftButtonOffset++,l.play("button")):this.leftButtonOffset>0&&(this.leftButtonOffset--,l.play("button"));else f<485||f>530?f<538||f>582?f>=590&&f<=635&&(this.mapMode=!this.mapMode,this.repairMode=this.sellMode=this.deployMode=!1):(this.sellMode=!this.sellMode,this.repairMode=this.mapMode=this.deployMode=!1):(this.repairMode=!this.repairMode,this.sellMode=this.mapMode=this.deployMode=!1)},allButtons:[],leftButtons:[],rightButtons:[],checkDependency:function(){for(var a=0;a<this.allButtons.length;a++){var b=this.allButtons[a],c=!0;for(var f=b.dependency.length-1;f>=0;f--){var g=!1,h=b.dependency[f];for(var i=d.buildings.length-1;i>=0;i--){var j=d.buildings[i];if(j.name==h&&j.status!="build"&&j.life!="ultra-damaged"&&j.team==d.currentLevel.team){g=!0;break}}if(!g){c=!1;break}}if(b.type=="building"){var k=!1,m;for(var f=this.leftButtons.length-1;f>=0;f--)if(this.leftButtons[f].name==b.name){k=!0,m=f;break}if(c&&!k)this.leftButtons.push(b),b.status="",b.counter=0,b.speed=this.buildSpeedMultiplier/b.cost,l.play("new_construction_options"),e.visible=!0;else if(k&&!c){if(this.leftButtons[m].status=="building"||this.leftButtons[m].status=="hold"||this.leftButtons[m].status=="ready")for(var f=this.leftButtons.length-1;f>=0;f--)this.leftButtons[f].status="";this.leftButtons.splice(m,1)}}else if(b.type=="infantry"||b.type=="vehicle"){var k=!1,m;for(var f=this.rightButtons.length-1;f>=0;f--)if(this.rightButtons[f].name==b.name){k=!0,m=f;break}if(c&&!k)this.rightButtons.push(b),b.status="",b.counter=0,b.speed=this.buildSpeedMultiplier/b.cost,l.play("new_construction_options");else if(k&&!c){if(this.rightButtons[m].status=="building"||this.rightButtons[m].status=="hold"||this.rightButtons[m].status=="ready")for(var f=this.rightButtons.length-1;f>=0;f--)this.rightButtons[f].dependency[0]==this.rightButtons[m].dependency[0]&&(this.rightButtons[f].status="");this.rightButtons.splice(m,1)}}}},load:function(){this.tabsImage=this.preloadImage("sidebar/tabs.png"),this.sidebarImage=this.preloadImage("sidebar/sidebar.png"),this.primaryBuildingImage=this.preloadImage("sidebar/primary.png"),this.readyImage=this.preloadImage("sidebar/ready.png"),this.holdImage=this.preloadImage("sidebar/hold.png"),this.placementWhiteImage=this.preloadImage("sidebar/placement-white.gif"),this.placementRedImage=this.preloadImage("sidebar/placement-red.gif"),this.powerIndicator=this.preloadImage("sidebar/power/power_indicator2.png"),this.messageBox=this.preloadImage("sidebar/message_box.jpg"),this.top=d.viewportTop-2,this.left=a.width-this.width;var b=[{name:"power-plant",type:"building",cost:300,dependency:["construction-yard"]},{name:"barracks",type:"building",cost:300,dependency:["construction-yard","power-plant"]},{name:"weapons-factory",type:"building",cost:300,dependency:["construction-yard","power-plant"]},{name:"minigunner",type:"infantry",cost:100,dependency:["barracks"]},{name:"light-tank",type:"vehicle",cost:600,dependency:["weapons-factory"]}];this.allButtons=[];for(var c=0;c<b.length;c++){var e=b[c];this.allButtons.push({name:e.name,image:this.preloadImage("sidebar/icons/"+e.name+"-icon.png"),type:e.type,status:"",cost:e.cost,dependency:e.dependency})}},textBrightness:0,textBrightnessDelta:-0.14,drawButtonLabel:function(a,c,d){var e=this.iconWidth/2-a.width/2,f=this.iconHeight/2;b.globalAlpha=this.textBrightness,b.drawImage(a,c+e,d+f),b.globalAlpha=1},drawButtonCost:function(a,c,d){var e=35,f=10;b.fillStyle="white",b.fillText(" "+a,c+e,d+f)},iconWidth:64,iconHeight:48,leftButtonOffset:0,rightButtonOffset:0,buildSpeedMultiplier:300,drawButton:function(a,c){var d=a=="left"?this.leftButtons:this.rightButtons,e=a=="left"?this.leftButtonOffset:this.rightButtonOffset,f=d[c+e],g=a=="left"?500:570,h=165+this.top+c*this.iconHeight;b.drawImage(f.image,g,h),f.status=="ready"?this.drawButtonLabel(this.readyImage,g,h):f.status=="disabled"?(b.fillStyle="rgba(200,200,200,0.6)",b.fillRect(g,h,this.iconWidth,this.iconHeight)):f.status=="building"?(u.clearRect(0,0,this.iconWidth,this.iconHeight),u.fillStyle="rgba(200,200,200,0.6)",u.beginPath(),u.moveTo(this.iconWidth/2,this.iconHeight/2),u.arc(this.iconWidth/2,this.iconHeight/2,40,Math.PI*2*f.counter/100-Math.PI/2,-Math.PI/2),u.moveTo(this.iconWidth/2,this.iconHeight/2),u.fill(),b.drawImage(t,0,0,this.iconWidth,this.iconHeight,g,h,this.iconWidth,this.iconHeight)):f.status=="hold"&&(u.clearRect(0,0,this.iconWidth,this.iconHeight),u.fillStyle="rgba(100,100,100,0.6)",u.beginPath(),u.moveTo(this.iconWidth/2,this.iconHeight/2),u.arc(this.iconWidth/2,this.iconHeight/2,40,Math.PI*2*f.counter/100-Math.PI/2,-Math.PI/2),u.moveTo(this.iconWidth/2,this.iconHeight/2),u.fill(),b.drawImage(t,0,0,this.iconWidth,this.iconHeight,g,h,this.iconWidth,this.iconHeight),this.drawButtonLabel(this.holdImage,g,h))},processButton:function(a,b){var c=a=="left"?this.leftButtons:this.rightButtons,d=a=="left"?this.leftButtonOffset:this.rightButtonOffset,e=c[b+d],f=a=="left"?500:570,g=165+this.top+b*this.iconHeight;if(e.status=="building"){e.counter+=e.speed,e.spent-=Math.round(e.cost*e.speed/100),this.cash-=Math.round(e.cost*e.speed/100);if(e.counter>99){this.cash-=e.spent,e.status="ready";if(a=="left")l.play("construction_complete");else if(e.type=="infantry"||e.type=="vehicle")l.play("unit_ready"),this.finishDeployingUnit(e)}}},powerOut:0,powerIn:0,lowPowerMode:!1,powerScale:4,checkPower:function(){var a=this.left,c=this.top+160,e=320,f=20;this.powerOut=0,this.powerIn=0;for(var g=d.buildings.length-1;g>=0;g--){var h=d.buildings[g];h.powerIn&&h.team==d.currentLevel.team&&(this.powerIn+=h.powerIn),h.powerOut&&h.team==d.currentLevel.team&&(this.powerOut+=h.powerOut)}var i="rgba(174,52,28,0.7)",j="rgba(250,100,0,0.6)",k="rgba(84,252,84,0.3)";this.powerOut/this.powerIn<1.1?this.powerOut/this.powerIn<1?this.powerOut<this.powerIn&&(b.fillStyle=i,this.lowPowerMode==0&&l.play("low_power"),this.lowPowerMode=!0):(b.fillStyle=j,this.lowPowerMode=!1):(b.fillStyle=k,this.lowPowerMode=!1),b.fillRect(a+8,c+e-this.powerOut/this.powerScale,f-14,this.powerOut/this.powerScale),b.drawImage(this.powerIndicator,a,c+e-this.powerIn/this.powerScale)},draw:function(){b.drawImage(this.tabsImage,0,this.top-this.tabsImage.height+2),b.fillStyle="lightgreen",b.font='12px "Command and Conquer"';var c=(this.cash+"").split("").join(" ");b.fillText(c,400-c.length*5/2,31),this.checkDependency(),this.textBrightness=this.textBrightness+this.textBrightnessDelta,this.textBrightness<0&&(this.textBrightness=1);for(var e=0;e<this.leftButtons.length;e++)this.processButton("left",e);for(var e=0;e<this.rightButtons.length;e++)this.processButton("right",e);if(this.visible){b.drawImage(this.sidebarImage,this.left,this.top),this.checkPower();var f=this.leftButtons.length>6?6:this.leftButtons.length;for(var e=0;e<f;e++)this.drawButton("left",e);var g=this.rightButtons.length>6?6:this.rightButtons.length;for(var e=0;e<g;e++)this.drawButton("right",e)}b.clearRect(0,d.viewportTop+d.viewportHeight,a.width,30)}},f={types:[],buildingDetails:{"construction-yard":{name:"construction-yard",label:"Construction Yard",powerIn:15,powerOut:30,cost:5e3,sight:3,hitPoints:400,imagesToLoad:[{name:"build",count:32},{name:"healthy",count:4},{name:"damaged",count:4},{name:"ultra-damaged",count:1},{name:"healthy-construct",count:20},{name:"damaged-construct",count:20}],gridShape:[[1,1,1],[1,1,1]]},barracks:{name:"barracks",label:"Power Plant",powerIn:20,cost:300,sight:3,hitPoints:400,imagesToLoad:[{name:"build",count:20},{name:"healthy",count:10},{name:"damaged",count:10},{name:"ultra-damaged",count:1}],gridShape:[[1,1],[1,1]]},"power-plant":{name:"power-plant",label:"Power Plant",powerOut:100,cost:300,sight:2,hitPoints:200,imagesToLoad:[{name:"build",count:20},{name:"healthy",count:4},{name:"damaged",count:4},{name:"ultra-damaged",count:1}],gridShape:[[1,0],[1,1]]},"weapons-factory":{name:"weapons-factory",label:"Weapons Factory",powerIn:30,cost:2e3,sight:2,hitPoints:200,imagesToLoad:[{name:"build",count:20},{name:"healthy",count:1},{name:"damaged",count:1},{name:"ultra-damaged",count:0},{name:"healthy-construct",count:9},{name:"damaged-construct",count:9},{name:"healthy-base",count:1},{name:"damaged-base",count:1},{name:"ultra-damaged-base",count:1}],gridShape:[[1,1,1],[1,1,1],[1,1,1]]}},preloadImage:m,loadImageArray:n,preloadCount:0,loadedCount:0,draw:function(){b.drawImage(this.bibImage,this.x*d.gridSize+d.viewportAdjustX,(this.y+this.gridHeight-1)*d.gridSize+d.viewportAdjustY);var a=this.getLife();this.status=="build"||this.status=="sell"?imageCategory="build":this.status==""?imageCategory=this.life:imageCategory=this.life+"-"+this.status;var c=this.imageArray[this.life+"-base"];c&&c.length>0&&this.status!="build"&&this.status!="sell"&&v(c[0],d.gridSize*this.x+d.viewportAdjustX,this.y*d.gridSize+d.viewportAdjustY,this.team,this.type);var e=this.imageArray[imageCategory];this.animationIndex||(this.animationIndex=0);if(e.length>Math.floor(this.animationIndex/this.animationSpeed)){var f=e[Math.floor(this.animationIndex/this.animationSpeed)];this.status=="sell"&&(f=e[e.length-1-Math.floor(this.animationIndex/this.animationSpeed)]),this.currentImage=f,v(f,this.x*d.gridSize+d.viewportAdjustX,this.y*d.gridSize+d.viewportAdjustY,this.team,this.type)}this.animationIndex++,this.animationIndex/this.animationSpeed>=e.length&&(this.animationIndex=0,this.status=="build"||this.status=="construct"?this.status="":this.status=="sell"&&(this.status="destroy")),this.drawSelection()},load:function(a){var b=this.buildingDetails[a],c={};c.defaults={type:"building",draw:f.draw,underPoint:q,drawSelection:p,getLife:o,animationSpeed:2,status:"",health:b.hitPoints,gridHeight:b.gridShape.length,gridWidth:b.gridShape[0].length,pixelHeight:b.gridShape.length*d.gridSize,pixelWidth:b.gridShape[0].length*d.gridSize,bibImage:this.preloadImage("buildings/bib/bib-"+b.gridShape[0].length+".gif"),pixelOffsetX:0,pixelOffsetY:0,pixelTop:0,pixelLeft
:0},c.imageArray=[];for(var e=b.imagesToLoad.length-1;e>=0;e--){var g=b.imagesToLoad[e].count,h=b.imagesToLoad[e].name;c.imageArray[h]=this.loadImageArray("buildings/"+a+"/"+a+"-"+h,g,".gif")}$.extend(c,b),this.types[a]=c},add:function(a){var b={};b.team=d.currentLevel.team;var c=a.name;return $.extend(b,this.types[c].defaults),$.extend(b,this.types[c]),$.extend(b,a),b}},g={types:[],vehicleDetails:{mcv:{name:"mcv",label:"Mobile Construction Vehicle",turnSpeed:3,speed:12,cost:5e3,hitPoints:200,sight:2,moveImageCount:32,pixelWidth:48,pixelHeight:48,pixelOffsetX:-24,pixelOffsetY:-24,collisionRadius:14,softCollisionRadius:18},"light-tank":{name:"light-tank",label:"Light Tank",turnSpeed:6,speed:18,cost:600,sight:3,hitPoints:300,primaryWeapon:9,reloadTime:2e3,moveImageCount:32,turretImageCount:32,pixelWidth:24,pixelHeight:24,pixelOffsetX:-12,pixelOffsetY:-12,collisionRadius:8,softCollisionRadius:11}},preloadImage:m,loadImageArray:n,preloadCount:0,loadedCount:0,collision:function(a){if(this==a)return!1;var b=Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2),c=Math.pow((this.collisionRadius+a.collisionRadius)/d.gridSize,2),e=Math.pow((this.softCollisionRadius+a.collisionRadius)/d.gridSize,2),f=Math.pow((this.softCollisionRadius+a.softCollisionRadius)/d.gridSize,2);return b>c?b<e?{type:"soft-hard",distance:Math.pow(b,.5)}:b>f?!1:{type:"soft",distance:Math.pow(b,.5)}:{type:"hard",distance:Math.pow(b,.5)}},load:function(a){var b=this.vehicleDetails[a],c={};c.defaults={type:"vehicle",draw:this.draw,drawSelection:p,underPoint:q,processOrders:this.processOrders,moveTo:this.moveTo,move:this.move,collision:this.collision,getLife:o,animationSpeed:4,health:b.hitPoints,pixelLeft:0,pixelTop:0,pixelOffsetX:0,pixelOffsetY:0,moveDirection:0,turretDirection:0},!b.moveImages&&b.moveImageCount&&(c.moveImages=this.loadImageArray("units/vehicles/"+b.name+"/"+b.name,b.moveImageCount,".gif")),!b.turretImages&&b.turretImageCount&&(c.turretImages=this.loadImageArray("units/vehicles/"+b.name+"/"+b.name+"-turret",b.turretImageCount,".gif")),$.extend(c,b),this.types[a]=c},draw:function(){var a=this.moveImages[Math.round(this.moveDirection)],c=this.x*d.gridSize+this.pixelOffsetX+d.viewportAdjustX,e=this.y*d.gridSize+this.pixelOffsetY+d.viewportAdjustY;d.debugMode&&(b.fillStyle="rgba(100,200,100,0.4)",b.beginPath(),b.arc(this.x*d.gridSize+d.viewportAdjustX,this.y*d.gridSize+d.viewportAdjustY,this.softCollisionRadius,0,Math.PI*2),b.fill(),b.fillStyle="rgba(200,0,0,0.4)",b.beginPath(),b.arc(this.x*d.gridSize+d.viewportAdjustX,this.y*d.gridSize+d.viewportAdjustY,this.collisionRadius,0,Math.PI*2),b.fill(),b.fillStyle="white",this.collisionType&&b.fillText(this.collisionType,c,e+10)),v(a,c,e,this.team,this.name=="mcv"?"mcv":this.type);if(this.turretImageCount){var f=this.turretImages[Math.round(this.turretDirection)];f||alert(Math.round(this.turretDirection)),v(f,c,e,this.team,this.type)}this.drawSelection(),b.debugMode&&(b.fillStyle="white",this.collisionType&&b.fillText(this.collisionType,c,e))},movementSpeed:0,moveTo:function(a,b){var c=[Math.floor(this.x),Math.floor(this.y)],e=[a.x,a.y];this.path=s(c,e),this.instructions=[];if(this.path.length>1){var f=y(this.path[1],this.path[0],32),g=this.movementSpeed*d.speedAdjustmentFactor/d.gridSize,h=this.moveDirection/32*2*Math.PI;this.x=this.x-g*Math.sin(h),this.y=this.y-g*Math.cos(h),this.colliding=!1;for(var i=d.units.length-1;i>=0;i--){var j;if(j=this.collision(d.units[i]))this.colliding=!0,j.distance<this.collisionDistance&&(this.collisionType=j.type,this.collisionDistance=j.distance,this.collisionWith=d.units[i])}for(var i=0;i<d.obstructionGrid.length;i++)for(var k=0;k<d.obstructionGrid[i].length;k++)if(d.obstructionGrid[i][k]>0){var l={x:k+.5,y:i+.5,collisionRadius:d.gridSize*.5,softCollisionRadius:d.gridSize*.7};if(j=this.collision(l))this.colliding=!0,j.distance<this.collisionDistance&&(this.collisionType=j.type,this.collisionDistance=j.distance,this.collisionWith=l)}this.x=this.x+g*Math.sin(h),this.y=this.y+g*Math.cos(h);if(this.colliding){var m=y(this.collisionWith,this,32),n=w(this.moveDirection,m,32),o=w(f,m,32);switch(this.collisionType){case"hard":this.movementSpeed=0,Math.abs(n)==0?(Math.abs(o)>0?f=x(this.moveDirection,-1*o/Math.abs(o),32):f=x(this.moveDirection,-1,32),this.moveDirection=f):Math.abs(n)>2?Math.abs(n)<4?(f=x(this.moveDirection,-1*n/Math.abs(n),32),this.moveDirection=f):Math.abs(n)<9?(f=x(this.moveDirection,-n/Math.abs(n),32),this.moveDirection=f):this.movementSpeed=this.speed:(f=x(this.moveDirection,-1*n/Math.abs(n),32),this.moveDirection=f);break;case"soft-hard":Math.abs(n)==0?(this.movementSpeed=0,Math.abs(o)>0?f=x(this.moveDirection,-1*o/Math.abs(o),32):f=x(this.moveDirection,-1,32),this.moveDirection=f):Math.abs(n)>2?Math.abs(n)<4?(this.movementSpeed=0,f=x(this.moveDirection,-1*n/Math.abs(n),32),this.moveDirection=f):Math.abs(n)<9?(this.movementSpeed=0,f=x(this.moveDirection,-1*n/Math.abs(n),32),this.moveDirection=f):this.movementSpeed=this.speed:(this.movementSpeed=0,f=x(this.moveDirection,-1*n/Math.abs(n),32),this.moveDirection=f);break;case"soft":Math.abs(n)==0?(this.movementSpeed=this.speed*(this.collisionDistance-this.collisionRadius)/(this.softCollisionRadius-this.collisionRadius),this.movementSpeed<0&&(this.movementSpeed=0),Math.abs(o)>0?f=x(this.moveDirection,-1*o/Math.abs(o),32):f=x(this.moveDirection,-1,32)):Math.abs(n)>2?Math.abs(n)<4?(this.movementSpeed=this.speed*(this.collisionDistance-this.collisionRadius)/(this.softCollisionRadius-this.collisionRadius),this.movementSpeed<0&&(this.movementSpeed=0),f=x(this.moveDirection,-n*1,32)):Math.abs(n)<9?(this.movementSpeed=this.speed,f=x(this.moveDirection,-n*1,32)):this.movementSpeed=this.speed:(this.movementSpeed=this.speed*(this.collisionDistance-this.collisionRadius)/(this.softCollisionRadius-this.collisionRadius),this.movementSpeed<0&&(this.movementSpeed=0),f=x(this.moveDirection,-n*1,32))}}else this.movementSpeed=this.speed;this.movementSpeed>this.speed?this.movementSpeed=this.speed:this.movementSpeed<-this.speed&&(this.movementSpeed=-this.speed),this.moveDirection!=f&&this.instructions.push({type:"turn",toDirection:f});var p=Math.abs(w(this.moveDirection,f,32));(p<8||this.colliding)&&this.instructions.push({type:"move",distance:1});var q;b?q=y({x:targetX,y:targetY},this,32):q=y(this.path[1],this.path[0],32),this.turretDirection!=q&&this.instructions.push({type:"aim",toDirection:q})}},processOrders:function(){this.colliding=!1,this.collisionType="",this.collisionDistance=this.softCollisionRadius+1,this.collisionWith=null,this.movementSpeed=0,this.instructions=[],this.orders||(this.orders={type:"guard"});if(this.orders.type=="make-way"){var a=y(this.orders.for,this,32),b=w(this.moveDirection,a,32);Math.abs(a)>16?this.instructions.push({type:"move",distance:.25}):this.instructions.push({type:"move",distance:-0.25}),this.movementSpeed=this.speed,this.orders={type:"guard"}}else if(this.orders.type=="move"){this.moveTo(this.orders.to);if(this.path.length<=1||this.colliding&&this.collisionType=="soft"&&this.path.length<=2||this.colliding&&this.collisionType=="soft-hard"&&this.path.length<=2||this.colliding&&this.collisionType=="hard"&&this.path.length<=2)this.orders={type:"guard"}}else if(this.orders.type=="patrol"){var c=r(this);if(c.length>0){var e=c[0];this.orders={type:"attack",target:e};return}this.moveTo(this.orders.to),path.length<=1&&(this.orders={type:"patrol",to:this.orders.from,from:this.orders.to})}else if(this.orders.type=="protect"||this.orders.type=="attack"){if(this.orders.target.status=="destroy"){this.orders={type:"guard"};return}var g=this.orders.target.x,h=this.orders.target.y;this.orders.target.type=="turret"&&(g+=this.orders.target.pixelWidth/(2*d.gridSize),h+=this.orders.target.pixelHeight/(2*d.gridSize)),this.orders.target.type=="building"&&(g+=this.orders.target.gridWidth/2,h+=this.orders.target.gridHeight),this.moveTo({x:Math.floor(g),y:Math.floor(h)},!0);if(Math.pow(g-this.x,2)+Math.pow(h-this.y,2)<=Math.pow(this.sight,2)&&this.orders.type=="attack"){var i=y({x:g,y:h},this,32);this.turretDirection==i&&this.instructions.push({type:"fire"})}}else if(this.orders.type=="build")this.moveDirection!=15?this.instructions.push({type:"turn",toDirection:15}):(this.status="destroy",l.play("construction"),d.buildings.push(f.add({name:"construction-yard",x:Math.floor(this.x)-1,y:Math.floor(this.y)-1,status:"build"})));else if(this.orders.type=="guard"){var c=r(this);if(c.length>0){var e=c[0];this.orders={type:"attack",target:e}}}},move:function(){this.moving=!1,this.attacking=!1,this.instructions||(this.instructions=[]);if(this.instructions.length==0)return;for(var a=0;a<this.instructions.length;a++){var b=this.instructions[a];b.type=="turn"&&(b.toDirection==this.moveDirection&&(b.type="done"),b.toDirection>this.moveDirection&&b.toDirection-this.moveDirection<16||b.toDirection<this.moveDirection&&this.moveDirection-b.toDirection>16?(this.moveDirection=this.moveDirection+this.turnSpeed*.1,(this.moveDirection-b.toDirection)*(this.moveDirection+this.turnSpeed*.1-b.toDirection)<=0&&(this.moveDirection=b.toDirection)):(this.moveDirection=this.moveDirection-this.turnSpeed*.1,(this.moveDirection-b.toDirection)*(this.moveDirection-this.turnSpeed*.1-b.toDirection)<=0&&(this.moveDirection=b.toDirection)),this.moveDirection>31?this.moveDirection=0:this.moveDirection<0&&(this.moveDirection=31));if(b.type=="move"){if(b.distance<=0){b.type="done";return}this.moving=!0;var c=this.movementSpeed*d.speedAdjustmentFactor/d.gridSize;b.distance-=c;var e=this.moveDirection/32*2*Math.PI;this.x=this.x-c*Math.sin(e),this.y=this.y-c*Math.cos(e)}if(b.type=="aim")if(b.toDirection==this.turretDirection)b.type="done";else{var f=w(Math.floor(this.turretDirection),Math.floor(b.toDirection),32);Math.abs(f)<1?(this.turretDirection=b.toDirection,b.type="done"):this.turretDirection=x(this.turretDirection,f/Math.abs(f),32)}if(b.type=="fire"&&!this.bulletFiring){l.play("tank_fire"),this.bulletFiring=!0;var e=this.turretDirection/32*2*Math.PI;d.fireBullet({x:this.x,y:this.y,angle:e,range:this.sight,source:this})}}},add:function(a){var b={},c=a.name;return b.team=d.currentLevel.team,$.extend(b,this.types[c].defaults),$.extend(b,this.types[c]),$.extend(b,a),b}},h={types:[],overlayDetails:{tiberium:{name:"tiberium",count:2,stageCount:12,gridOffsetX:0,gridOffsetY:0},tree:{name:"tree",count:1,stageCount:10,gridOffsetX:0,gridOffsetY:-1},trees:{name:"trees",count:1,stageCount:10,gridOffsetX:0,gridOffsetY:-1}},load:function(a){var b={name:a,draw:this.draw},c=this.overlayDetails[a],d=[];for(i=0;i<c.count;i++)d[i]=this.loadImageArray("tiles/temperate/"+a+"/"+a+"-"+i,c.stageCount,".gif");b.imageArray=d,$.extend(b,c),this.types[a]=b},draw:function(){var a=this.imageArray[this.type][this.stage],b=(this.x+this.gridOffsetX)*d.gridSize+d.viewportAdjustX,c=(this.y+this.gridOffsetY)*d.gridSize+d.viewportAdjustY;v(a,b,c)},loadAll:function(){this.load("tiberium"),this.load("tree"),this.load("trees")},add:function(a){var b={type:0,stage:0},c=a.name;return $.extend(b,this.types[c]),$.extend(b,a),b},loaded:!0,preloadCount:0,loadedCount:0,preloadImage:m,loadImageArray:n},j={levelDetails:{gdi1:{mapUrl:"maps/gdi/map01.jpeg",startingCash:4e3,terrain:[{x1:0,y1:27,x2:30,y2:30,type:"water"},{x1:0,y1:26,x2:6,y2:26,type:"water"},{x1:0,y1:25,x2:5,y2:25,type:"water"},{x1:0,y1:24,x2:4,y2:24,type:"water"},{x1:29,y1:17,x2:30,y2:22,type:"mountain"},{x1:7,y1:6,x2:8,y2:9,type:"mountain"},{x1:8,y1:10,x2:9,y2:11,type:"mountain"},{x1:9,y1:11,x2:10,y2:15,type:"mountain"},{x1:10,y1:15,x2:11,y2:19,type:"mountain"},{x1:11,y1:19,x2:12,y2:21,type:"mountain"},{x1:12,y1:21,x2:14,y2:23,type:"mountain"},{x1:12,y1:24,x2:13,y2:24,type:"mountain"},{x1:14,y1:21,x2:17,y2:22,type:"mountain"},{x1:16,y1:23,x2:16,y2:23,type:"mountain"},{x1:0,y1:0,x2:30,y2:0,type:"mountain"},{x1:0,y1:0,x2:0,y2:25,type:"mountain"},{x1:30,y1:0,x2:30,y2:26,type:"mountain"}],overlay:[{x:10,y:10,name:"tree"},{x:16,y:3,name:"tree"},{x:14,y:2,name:"trees"},{x:9,y:2,name:"trees"},{x:19,y:12,name:"trees"},{x:15,y:13,name:"trees"},{x:0,y:1,name:"trees"},{x:2,y:1,name:"trees"},{x:4,y:1,name:"trees"},{x:8,y:1,name:"tree"},{x:6,y:0,name:"tree"},{x:7,y:0,name:"tree"},{x:12,y:15,name:"tiberium",stage:11},{x:13,y:15,name:"tiberium",stage:8},{x:13,y:16,name:"tiberium",stage:6}],gridWidth:32,gridHeight:32,team:"gdi",briefing:"This is a warning \n for all of you \n Kill enemy troops and have some fun",items:{vehicles:["mcv","light-tank"]},scriptedEvents:[]},gdi2:{mapUrl:"maps/gdi/map02.jpeg",startingCash:4e3,terrain:[{x1:0,y1:0,x2:0,y2:63,type:"water"},{x1:63,y1:0,x2:63,y2:63,type:"water"},{x1:0,y1:0,x2:63,y2:0,type:"water"},{x1:0,y1:63,x2:63,y2:63,type:"water"},{x1:1,y1:1,x2:11,y2:2,type:"water"},{x1:3,y1:3,x2:5,y2:3,type:"water"},{x1:8,y1:3,x2:10,y2:4,type:"water"},{x1:2,y1:15,x2:7,y2:17,type:"water"},{x1:1,y1:17,x2:5,y2:18,type:"water"},{x1:1,y1:20,x2:2,y2:22,type:"water"},{x1:3,y1:19,x2:3,y2:21,type:"water"},{x1:6,y1:22,x2:15,y2:23,type:"water"},{x1:16,y1:1,x2:33,y2:1,type:"water"},{x1:22,y1:2,x2:23,y2:10,type:"water"},{x1:19,y1:11,x2:22,y2:12,type:"water"},{x1:18,y1:3,x2:30,y2:4,type:"water"},{x1:19,y1:13,x2:19,y2:16,type:"water"},{x1:22,y1:13,x2:24,y2:13,type:"water"},{x1:15,y1:13,x2:18,y2:16,type:"water"},{x1:18,y1:20,x2:20,y2:21,type:"water"},{x1:16,y1:21,x2:17,y2:22,type:"water"},{x1:5,y1:23,x2:7,y2:24,type:"water"},{x1:1,y1:28,x2:2,y2:36,type:"water"},{x1:3,y1:31,x2:5,y2:34,type:"water"},{x1:3,y1:39,x2:25,y2:40,type:"water"},{x1:27,y1:35,x2:30,y2:38,type:"water"},{x1:26,y1:39,x2:26,y2:39,type:"water"},{x1:58,y1:37,x2:59,y2:37,type:"water"},{x1:57,y1:1,x2:62,y2:7,type:"water"},{x1:14,y1:51,x2:21,y2:52,type:"water"},{x1:24,y1:46,x2:25,y2:49,type:"water"},{x1:25,y1:49,x2:26,y2:54,type:"water"},{x1:25,y1:53,x2:32,y2:54,type:"water"},{x1:31,y1:53,x2:32,y2:63,type:"water"},{x1:28,y1:42,x2:35,y2:43,type:"water"},{x1:35,y1:35,x2:36,y2:43,type:"water"},{x1:27,y1:17,x2:28,y2:19,type:"water"},{x1:25,y1:19,x2:26,y2:23,type:"water"},{x1:27,y1:23,x2:34,y2:23,type:"water"},{x1:33,y1:23,x2:34,y2:32,type:"water"},{x1:15,y1:24,x2:16,y2:28,type:"water"},{x1:59,y1:8,x2:62,y2:8,type:"water"},{x1:61,y1:8,x2:62,y2:16,type:"water"},{x1:58,y1:12,x2:60,y2:17,type:"water"},{x1:56,y1:10,x2:57,y2:10,type:"water"},{x1:56,y1:14,x2:57,y2:16,type:"water"},{x1:55,y1:15,x2:55,y2:15,type:"water"},{x1:55,y1:12,x2:55,y2:12,type:"water"},{x1:37,y1:1,x2:49,y2:2,type:"water"},{x1:34,y1:2,x2:47,y2:3,type:"water"},{x1:36,y1:3,x2:43,y2:5,type:"water"},{x1:37,y1:13,x2:42,y2:17,type:"water"},{x1:58,y1:21,x2:60,y2:24,type:"water"},{x1:48,y1:9,x2:49,y2:10,type:"water"},{x1:47,y1:13,x2:48,y2:14,type:"water"},{x1:40,y1:18,x2:53,y2:18,type:"water"},{x1:39,y1:19,x2:44,y2:21,type:"water"},{x1:59,y1:24,x2:62,y2:30,type:"water"},{x1:52,y1:37,x2:58,y2:38,type:"water"},{x1:52,y1:17,x2:53,y2:17,type:"water"},{x1:41,y1:34,x2:44,y2:34,type:"water"},{x1:41,y1:34,x2:44,y2:34,type:"water"},{x1:41,y1:34,x2:44,y2:34,type:"water"},{x1:45,y1:33,x2:49,y2:33,type:"water"},{x1:49,y1:36,x2:53,y2:40,type:"water"},{x1:49,y1:36,x2:53,y2:40,type:"water"},{x1:53,y1:39,x2:56,y2:40,type:"water"},{x1:46,y1:46,x2:51,y2:50,type:"water"},{x1:38,y1:42,x2:42,y2:49,type:"water"},{x1:38,y1:53,x2:40,y2:62,type:"water"},{x1:19,y1:8,x2:22,y2:10,type:"water"},{x1:44,y1:38,x2:48,y2:39,type:"water"},{x1:41,y1:40,x2:44,y2:41,type:"water"},{x1:40,y1:41,x2:42,y2:41,type:"water"},{x1:31,y1:12,x2:37,y2:13,type:"water"},{x1:30,y1:12,x2:30,y2:15,type:"water"},{x1:27,y1:14,x2:30,y2:15,type:"water"},{x1:33,y1:56,x2:35,y2:61,type:"water"},{x1:25,y1:56,x2:25,y2:57,type:"water"},{x1:24,y1:60,x2:30,y2:62,type:"water"},{x1:22,y1:61,x2:23,y2:62,type:"water"},{x1:17,y1:62,x2:23,y2:62,type:"water"},{x1:30,y1:56,x2:30,y2:57,type:"water"},{x1:17,y1:28,x2:21,y2:29,type:"water"},{x1:48,y1:45,x2:53,y2:46,type:"water"},{x1:14,y1:53,x2:15,y2:53,type:"water"},{x1:17,y1:53,x2:18,y2:53,type:"water"},{x1:23,y1:48,x2:23,y2:48,type:"water"},{x1:1,y1:45,x2:4,y2:53,type:"water"},{x1:5,y1:50,x2:5,y2:52,type:"water"},{x1:1,y1:54,x2:2,y2:55,type:"water"},{x1:4,y1:58,x2:4,y2:59,type:"water"},{x1:4,y1:58,x2:4,y2:59,type:"water"},{x1:7,y1:59,x2:7,y2:60,type:"water"},{x1:3,y1:41,x2:20,y2:41,type:"water"},{x1:3,y1:42,x2:14,y2:42,type:"water"},{x1:5,y1:43,x2:13,y2:43,type:"water"},{x1:34,y1:33,x2:35,y2:35,type:"water"}],overlay:[],gridWidth:64,gridHeight:64,team:"gdi",briefing:"",items:{vehicles:["mcv","light-tank"]},scriptedEvents:[]}},preloadImage:m,loaded:!0,preloadCount:0,loadedCount:0,load:function(a){var b={};b.id=a,b.mapImage=this.preloadImage(this.levelDetails[a].mapUrl);var c=this.levelDetails[a];for(item in c.items)if(item=="vehicles")for(var d=c.items[item].length-1;d>=0;d--)g.load(this.levelDetails[a].items[item][d]);var f=new Array,i=new Array;for(var j=0;j<c.gridHeight;j++){f[j]=new Array,i[j]=new Array;for(var k=0;k<c.gridWidth;k++)f[j][k]=0}for(var d=c.terrain.length-1;d>=0;d--){var l=c.terrain[d];for(var k=l.x1;k<=l.x2;k++)for(var j=l.y1;j<=l.y2;j++)f[j][k]=1,i[j][k]=l.type}var m=[];for(var d=c.overlay.length-1;d>=0;d--)m.push(h.add(c.overlay[d]));return b.mapGrid=i,b.obstructionGrid=f,b.overlay=m,e.cash=c.startingCash,b}},l={sound_list:[],loaded:!0,load:function(a,b){var c=new Audio("audio/"+b+"/"+a+".ogg");return c.load(),c},play:function(a,b){var c=this.sound_list[a];if(c.length==1)c[0].play();else{var d=Math.floor(c.length*Math.random());c[d].play()}},loadAll:function(){this.sound_list.vehicle_select=[this.load("ready_and_waiting","talk"),this.load("vehicle_reporting","talk"),this.load("awaiting_orders","talk")],this.sound_list.vehicle_move=[this.load("affirmative","talk"),this.load("moving_out","talk"),this.load("acknowledged","talk"),this.load("over_and_out","talk")],this.sound_list.infantry_select=[this.load("reporting","talk"),this.load("unit_reporting","talk"),this.load("awaiting_orders","talk")],this.sound_list.infantry_move=[this.load("affirmative","talk"),this.load("yes_sir","talk"),this.load("acknowledged","talk"),this.load("right_away","talk")]}},t=document.createElement("canvas"),u=t.getContext("2d"),A=function(){function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return a&&(c&&!i[e][g]&&(l[m++]={x:g,y:e}),d&&!i[e][h]&&(l[m++]={x:h,y:e})),b&&(c&&!i[f][g]&&(l[m++]={x:g,y:f}),d&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function b(a,b,c,d,e,f,g,h,i,j,k,l,m){return a=e>-1,b=f<j,c=g<k,d=h>-1,c&&(a&&!i[e][g]&&(l[m++]={x:g,y:e}),b&&!i[f][g]&&(l[m++]={x:g,y:f})),d&&(a&&!i[e][h]&&(l[m++]={x:h,y:e}),b&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function c(a,b,c,d,e,f,g,h,i,j,k,l,m){return l}function d(a,b,c,d,e,f){var g=c-1,h=c+1,i=b+1,j=b-1,k=g>-1&&!d[g][b],l=h<e&&!d[h][b],m=i<f&&!d[c][i],n=j>-1&&!d[c][j],o=[],p=0;return k&&(o[p++]={x:b,y:g}),m&&(o[p++]={x:i,y:c}),l&&(o[p++]={x:b,y:h}),n&&(o[p++]={x:j,y:c}),a(k,l,m,n,g,h,i,j,d,e,f,o,p)}function e(a,b,c,d){return d(c(a.x-b.x),c(a.y-b.y))}function f(a,b,c,d){var e=a.x-b.x,f=a.y-b.y;return d(e*e+f*f)}function g(a,b,c,d){return c(a.x-b.x)+c(a.y-b.y)}function h(h,i,j,k){var l=h[0].length,m=h.length,n=l*m,o=Math.abs,p=Math.max,q={},r=[],s=[{x:i[0],y:i[1],f:0,g:0,v:i[0]+i[1]*l}],t=1,u,v,w,x,y,z,A,B,C;j={x:j[0],y:j[1],v:j[0]+j[1]*l};switch(k){case"Diagonal":w=a;case"DiagonalFree":v=e;break;case"Euclidean":w=a;case"EuclideanFree":p=Math.sqrt,v=f;break;default:v=g,w=c}w||(w=b);do{z=n,A=0;for(x=0;x<t;++x)(k=s[x].f)<z&&(z=k,A=x);B=s.splice(A,1)[0];if(B.v!=j.v){--t,C=d(w,B.x,B.y,h,m,l);for(x=0,y=C.length;x<y;++x)(u=C[x]).p=B,u.f=u.g=0,u.v=u.x+u.y*l,u.v in q||(u.f=(u.g=B.g+v(u,B,o,p))+v(u,j,o,p),s[t++]=u,q[u.v]=1)}else{x=t=0;do r[x++]={x:B.x,y:B.y};while(B=B.p);r.reverse()}}while(t);return r}return h}();d.start(),$("#debug_mode").bind("change",function(){d.debugMode=!d.debugMode})})